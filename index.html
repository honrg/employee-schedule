<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VXI-Mammotionç­è¡¨</title>
<link rel="icon" href="https://cdn.jsdelivr.net/gh/honrg/employee-schedule@main/LOGO.png" type="image/png">
<!-- Vue 3 CDN -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<style>
/* ------------------------ åŸæœ‰æ ·å¼ä¿æŒ ------------------------ */
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Microsoft YaHei',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden}.header{background:linear-gradient(135deg,#2c3e50,#34495e);color:white;padding:30px;text-align:center;position:relative}.logo-title{display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:10px}.logo{width:50px;height:50px;border-radius:8px;object-fit:contain}.header h1{font-size:2.5em;margin:0}.header .tips{opacity:.8;font-size:1em;margin-top:10px;color:#bdc3c7}.user-info{background:#2ecc71;color:white;padding:10px 20px;border-radius:20px;display:inline-block;margin-top:15px;cursor:pointer;transition:all .3s ease}.user-info:hover{background:#27ae60;transform:scale(1.05)}.user-info.global-mode{background:#3498db}.user-info.global-mode:hover{background:#2980b9}.controls{background:#f8f9fa;padding:20px;border-bottom:1px solid #e9ecef}.filter-group{display:flex;flex-wrap:wrap;gap:15px;align-items:center;justify-content:center}select,button,input{padding:12px 20px;border:2px solid #e9ecef;border-radius:8px;font-size:16px;background:white;cursor:pointer;transition:all .3s ease}select:focus,button:hover,input:focus{border-color:#3498db;box-shadow:0 0 0 3px rgba(52,152,219,.1)}button{background:#3498db;color:white;border-color:#3498db}button:hover{background:#2980b9;transform:translateY(-2px)}button.secondary{background:#95a5a6;border-color:#95a5a6}button.secondary:hover{background:#7f8c8d}.user-selector{margin-top:15px;text-align:center}.user-search-container{position:relative;display:inline-block;margin-right:10px}.user-search{padding:10px 15px;width:300px;font-size:14px}.search-results{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1000;display:none}.search-result{padding:10px 15px;cursor:pointer;border-bottom:1px solid #f0f0f0}.search-result:hover{background:#f8f9fa}.search-result:last-child{border-bottom:none}.calendar-container{padding:20px;min-height:400px}.month-section{background:white;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.08);overflow:hidden;margin-bottom:0}.month-header{background:linear-gradient(135deg,#3498db,#2980b9);color:white;padding:20px;text-align:center;font-size:1.5em;font-weight:bold}.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#34495e;color:white}.weekday{padding:15px;text-align:center;font-weight:bold;border-right:1px solid #2c3e50}.weekday:last-child{border-right:none}.days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e9ecef}.day{background:white;min-height:120px;padding:10px;border:1px solid #e9ecef;position:relative;cursor:pointer;transition:all .3s ease}.day:hover{background:#f8f9fa;transform:scale(1.02)}.day.other-month{background:#f8f9fa;color:#adb5bd}.day.other-month:hover{background:#e9ecef}.day-number{font-weight:bold;margin-bottom:5px;color:#2c3e50;font-size:14px}.shift-item{background:#e74c3c;color:white;padding:4px 6px;margin:2px 0;border-radius:4px;font-size:11px;cursor:pointer;transition:all .3s ease;line-height:1.2}.shift-item:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,.2)}.shift-A{background:#2ecc71}.shift-B{background:#f39c12}.shift-C{background:#9b59b6}.shift-D{background:#e74c3c}.shift-E{background:#1abc9c}.shift-F{background:#e67e22}.shift-G{background:#34495e}.loading{text-align:center;padding:40px;font-size:1.2em;color:#7f8c8d}.error{background:#e74c3c;color:white;padding:20px;margin:20px;border-radius:8px;text-align:center}.empty-state{text-align:center;padding:60px 20px;color:#7f8c8d}.empty-state h3{margin-bottom:10px;color:#2c3e50}.day-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}.modal-content{background:white;padding:30px;border-radius:15px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.2)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}.modal-title{font-size:1.5em;color:#2c3e50;margin:0}.close-modal{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:16px}.close-modal:hover{background:#c0392b}.day-shifts{display:grid;gap:10px}.day-shift-item{background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #3498db}.day-shift-item.excluded{opacity:.6;border-left-color:#95a5a6}.shift-name{font-weight:bold;color:#2c3e50;margin-bottom:5px}.shift-time{color:#7f8c8d;font-size:14px}.mode-indicator{display:inline-block;margin-left:10px;padding:2px 8px;background:#f39c12;color:white;border-radius:10px;font-size:12px;vertical-align:middle}.debug-info{background:#f8f9fa;padding:15px;margin:10px;border-radius:5px;font-family:monospace;font-size:12px;border-left:4px solid #3498db;display:none}@media(max-width:768px){.day{min-height:100px;padding:5px}.shift-item{font-size:10px;padding:2px 4px}.filter-group{flex-direction:column}select,button,input{width:100%}.logo-title{flex-direction:column;gap:10px}.user-search{width:100%}.modal-content{width:95%;padding:20px}}
</style>
</head>
<body>
<div id="app" class="container">
  <div class="header">
    <div class="logo-title">
      <img :src="logoUrl" alt="VXI-Mammotion Logo" class="logo" @error="logoError">
      <h1>VXI-Mammotionç­è¡¨</h1>
    </div>
    <div class="tips">ç‚¹å‡»ç”¨æˆ·èº«ä»½å¯é‡æ–°é€‰æ‹© | æœªé€‰æ‹©èº«ä»½æ—¶å¯ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹å½“å¤©æ‰€æœ‰ç­æ¬¡</div>
    <div class="user-info" :class="{'global-mode': !currentUserName}" @click="showUserSelector">
      {{ currentUserName ? 'å½“å‰èº«ä»½: ' + currentUserName : 'ç‚¹å‡»é€‰æ‹©èº«ä»½ (å…¨å±€æ¨¡å¼)' }}
    </div>
    <div class="user-selector" v-show="showSelector">
      <div class="user-search-container">
        <input type="text" class="user-search" placeholder="è¾“å…¥å®Œæ•´è‹±æ–‡å(ä¸åŒºåˆ†å¤§å°å†™)..." v-model="userSearch" @input="filterUsers">
        <div class="search-results" v-show="filteredUsers.length > 0">
          <div class="search-result" v-for="user in filteredUsers" :key="user" @click="selectUser(user)">{{ user }}</div>
        </div>
      </div>
      <button @click="confirmUserSelection">ç¡®è®¤èº«ä»½</button>
      <button class="secondary" @click="clearUserSelection">å–æ¶ˆ</button>
    </div>
  </div>
  <div class="controls">
    <div class="filter-group">
      <select v-model="selectedYear" @change="renderCalendar">
        <option value="">é€‰æ‹©å¹´ä»½</option>
        <option v-for="year in years" :value="year">{{ year }}å¹´</option>
      </select>
      <select v-model="selectedMonth" @change="renderCalendar">
        <option value="">é€‰æ‹©æœˆä»½</option>
        <option v-for="(monthName, idx) in 12" :value="(idx+1).toString().padStart(2,'0')">{{ idx+1 }}æœˆ</option>
      </select>
      <button @click="refreshData">åˆ·æ–°æ•°æ®</button>
      <button v-if="availableUsers.includes('Sugar')" id="debugButton" @click="toggleDebug">è°ƒè¯•ä¿¡æ¯</button>
    </div>
  </div>
  <div class="calendar-container" v-html="calendarHtml"></div>
  <div class="day-modal" v-show="showModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">{{ modalTitle }}</h2>
        <button class="close-modal" @click="closeModal">å…³é—­</button>
      </div>
      <div class="day-shifts">
        <div v-if="dayShifts.length===0" class="empty-state">
          <h3>å½“æ—¥æ— ç­æ¬¡å®‰æ’</h3>
        </div>
        <div v-for="shift in dayShifts" :key="shift.userName + shift.shiftCode" :class="['day-shift-item', {'excluded': excludedShifts.includes(shift.shiftCode)}]">
          <div class="shift-name">{{ shift.userName }} - {{ shift.shiftCode }}ç­</div>
          <div class="shift-time">{{ shift.startTime }} - {{ shift.endTime }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="debug-info" v-show="showDebug">
    <h4>ğŸ“Š ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯</h4>
    <div v-for="log in debugLogs" :key="log">{{ log }}</div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      logoUrl: 'https://cdn.jsdelivr.net/gh/honrg/employee-schedule@main/LOGO.png',
      allScheduleData: [],
      availableUsers: [],
      filteredUsers: [],
      currentUserName: '',
      currentUserShifts: [],
      userSearch: '',
      showSelector: false,
      selectedYear: '',
      selectedMonth: '',
      years: [],
      calendarHtml: '<div class="loading">â³ æ­£åœ¨åŠ è½½ç­è¡¨æ•°æ®...</div>',
      showModal: false,
      modalTitle: '',
      dayShifts: [],
      showDebug: false,
      debugLogs: [],
      excludedShifts: ['ä¼‘','ç¦»èŒ'],
      CONFIG: {
        DATA_URL: 'https://cdn.jsdelivr.net/gh/honrg/employee-schedule@main/schedule.csv',
        CACHE_DURATION: 1*60*1000
      }
    }
  },
  mounted() {
    this.loadScheduleData();
  },
  methods: {
    logoError(e){ e.target.style.display='none'; },
    logDebug(msg){
      console.log(msg);
      if(this.currentUserName==='Sugar'){
        const timestamp = new Date().toLocaleTimeString();
        this.debugLogs.push(`[${timestamp}] ${msg}`);
      }
    },
    toggleDebug(){ if(this.currentUserName==='Sugar'){ this.showDebug=!this.showDebug; } },
    showUserSelector(){ this.showSelector=true; this.userSearch=''; this.filteredUsers=[...this.availableUsers]; },
    filterUsers(){ 
      const term = this.userSearch.toLowerCase();
      this.filteredUsers = term? this.availableUsers.filter(u=>u.toLowerCase().includes(term)): [...this.availableUsers];
    },
    selectUser(user){ this.userSearch=user; this.filteredUsers=[]; },
    confirmUserSelection(){
      const input = this.userSearch.trim();
      const matched = this.availableUsers.find(u=>u.toLowerCase()===input.toLowerCase());
      if(!matched){ alert('æœªæ‰¾åˆ°è¯¥å‘˜å·¥ï¼Œè¯·æ£€æŸ¥å§“å'); return;}
      this.currentUserName = matched;
      this.showSelector=false;
      this.filterUserShifts();
      this.renderCalendar();
    },
    clearUserSelection(){ this.currentUserName=''; this.showSelector=false; this.currentUserShifts=[]; this.renderCalendar(); },
    getCachedData(){ try{ const cached=localStorage.getItem('schedule_cache'); const last=localStorage.getItem('schedule_last_update'); if(cached&&last){ const age=Date.now()-parseInt(last); if(age<this.CONFIG.CACHE_DURATION){ this.logDebug('ä½¿ç”¨ç¼“å­˜æ•°æ®:'+Math.round(age/1000)+'ç§’'); return JSON.parse(cached); } } }catch(e){ console.warn(e);} return null; },
    cacheData(data){ try{ localStorage.setItem('schedule_cache',JSON.stringify(data)); localStorage.setItem('schedule_last_update',Date.now().toString()); this.logDebug('æ•°æ®å·²ç¼“å­˜'); }catch(e){console.warn(e);} },
    async loadScheduleData(){
      let cached=this.getCachedData();
      if(cached){ this.allScheduleData=cached; this.initializeAfterDataLoad(); return; }
      try{
        this.calendarHtml='<div class="loading">â³ æ­£åœ¨åŠ è½½ç­è¡¨æ•°æ®...</div>';
        const res=await fetch(this.CONFIG.DATA_URL+'?t='+Date.now());
        const text=await res.text();
        this.allScheduleData=this.parseCSV(text);
        if(this.allScheduleData.length===0) throw new Error('CSVæ— æœ‰æ•ˆæ•°æ®');
        this.cacheData(this.allScheduleData);
        this.initializeAfterDataLoad();
      }catch(e){
        console.error(e);
        let cached=this.getCachedData();
        if(cached){ this.allScheduleData=cached; this.initializeAfterDataLoad(); }
        else{ this.calendarHtml='<div class="error">æ•°æ®åŠ è½½å¤±è´¥: '+e.message+'</div>'; }
      }
    },
    initializeAfterDataLoad(){
      this.availableUsers=[...new Set(this.allScheduleData.map(s=>s.userName))].sort();
      this.filteredUsers=[...this.availableUsers];
      this.populateYearMonthFilter();
    },
    parseCSV(text){
      const lines=text.split('\n');
      if(lines.length===0) return [];
      const headers=lines[0].split(',').map(h=>h.trim());
      const result=[];
      for(let i=1;i<lines.length;i++){
        const vals=lines[i].split(',').map(v=>v.trim());
        if(vals.length>=3){
          result.push({
            userName: vals[0]||'æœªçŸ¥ç”¨æˆ·',
            shiftCode: vals[1]||'A',
            shiftDate:this.formatDate(vals[2]),
            startTime:this.formatTime(vals[3]||'09:00'),
            endTime:this.formatTime(vals[4]||'18:00')
          });
        }
      }
      return result;
    },
    formatDate(dateValue){
      if(!dateValue) return '';
      if(typeof dateValue==='object') return dateValue.toISOString().split('T')[0];
      let dateStr=String(dateValue).trim();
      if(/^\d+$/.test(dateStr)){ const d=new Date((parseInt(dateStr)-25569)*86400*1000); return d.toISOString().split('T')[0];}
      if(dateStr.includes('/')){ const p=dateStr.split('/'); if(p.length===3){ let [y,m,d]=p; if(m.length===1)m='0'+m;if(d.length===1)d='0'+d; if(y.length===2)y='20'+y; return `${y}-${m}-${d}`; } }
      if(dateStr.includes('-')){ const p=dateStr.split('-'); if(p.length===3){ let [y,m,d]=p; if(m.length===1)m='0'+m;if(d.length===1)d='0'+d; return `${y}-${m}-${d}`;} return dateStr.split(' ')[0]; }
      return dateStr;
    },
    formatTime(value){
      if(!value) return '09:00';
      if(/^\d+\.\d+$/.test(value)){ const total=Math.round(parseFloat(value)*24*3600); const h=Math.floor(total/3600); const m=Math.floor((total%3600)/60); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }
      return value;
    },
    populateYearMonthFilter(){
      const yearsSet=new Set(this.allScheduleData.map(d=>parseInt(d.shiftDate.split('-')[0])));
      this.years=[...yearsSet].sort();
      this.selectedYear=''; this.selectedMonth='';
      this.renderCalendar();
    },
    filterUserShifts(){
      if(this.currentUserName){ this.currentUserShifts=this.allScheduleData.filter(d=>d.userName===this.currentUserName); } 
      else { this.currentUserShifts=[]; }
    },
    renderCalendar(){
      const year=this.selectedYear||new Date().getFullYear();
      const month=this.selectedMonth||'';
      let calendarHtml='';
      for(let m=1;m<=12;m++){
        if(month&&parseInt(month)!==m) continue;
        const monthData=this.allScheduleData.filter(d=>parseInt(d.shiftDate.split('-')[0])===parseInt(year)&&parseInt(d.shiftDate.split('-')[1])===m);
        const firstDay=new Date(year,m-1,1); const lastDay=new Date(year,m,0);
        const weekdayFirst=firstDay.getDay();
        const totalDays=lastDay.getDate();
        calendarHtml+=`<div class="month-section"><div class="month-header">${m}æœˆ ${year}</div>`;
        calendarHtml+='<div class="weekdays">'+['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w=>`<div class="weekday">${w}</div>`).join('')+'</div>';
        calendarHtml+='<div class="days-grid">';
        for(let i=0;i<weekdayFirst;i++){ calendarHtml+='<div class="day other-month"></div>'; }
        for(let d=1;d<=totalDays;d++){
          const dateStr=`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const dayShifts=this.currentUserName? this.currentUserShifts.filter(s=>s.shiftDate===dateStr): this.allScheduleData.filter(s=>s.shiftDate===dateStr);
          let shiftsHtml=dayShifts.map(s=>`<div class="shift-item shift-${s.shiftCode}" onclick="app.openDayModal('${dateStr}')">${s.shiftCode}</div>`).join('');
          calendarHtml+=`<div class="day" onclick="app.openDayModal('${dateStr}')"><div class="day-number">${d}</div>${shiftsHtml}</div>`;
        }
        calendarHtml+='</div></div>';
      }
      this.calendarHtml=calendarHtml;
    },
    openDayModal(dateStr){
      const dayShifts=this.currentUserName? this.currentUserShifts.filter(s=>s.shiftDate===dateStr): this.allScheduleData.filter(s=>s.shiftDate===dateStr);
      this.modalTitle=`${dateStr} ç­æ¬¡è¯¦æƒ…`;
      this.dayShifts=dayShifts;
      this.showModal=true;
    },
    closeModal(){ this.showModal=false; },
    refreshData(){ localStorage.removeItem('schedule_cache'); localStorage.removeItem('schedule_last_update'); this.loadScheduleData(); }
  }
}).mount('#app');

window.app = createApp; // ä¿è¯ onclick è°ƒç”¨å¯ç”¨
</script>
</body>
</html>
