<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å‘˜å·¥ç­è¡¨ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†ç®€æ´çœç•¥ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; text-align: center; }
        .controls { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; }
        select, button { padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: white; cursor: pointer; }
        button { background: #3498db; color: white; border-color: #3498db; }
        .calendar-container { padding: 20px; }
        .month-section { margin-bottom: 40px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .month-header { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background: #34495e; color: white; }
        .weekday { padding: 15px; text-align: center; font-weight: bold; border-right: 1px solid #2c3e50; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; }
        .day { background: white; min-height: 120px; padding: 10px; border: 1px solid #e9ecef; position: relative; }
        .day.other-month { background: #f8f9fa; color: #adb5bd; }
        .day-number { font-weight: bold; margin-bottom: 5px; color: #2c3e50; }
        .shift-item { background: #e74c3c; color: white; padding: 4px 8px; margin: 2px 0; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .shift-A { background: #2ecc71; }
        .shift-B { background: #f39c12; }
        .shift-C { background: #9b59b6; }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #7f8c8d; }
        .error { background: #e74c3c; color: white; padding: 20px; margin: 20px; border-radius: 8px; text-align: center; }
        .debug-info { background: #f8f9fa; padding: 15px; margin: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .user-info { background: #2ecc71; color: white; padding: 10px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… æ™ºèƒ½å‘˜å·¥ç­è¡¨ç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·èº«ä»½ Â· å®æ—¶æ›´æ–°ç­è¡¨æ•°æ®</p>
            <div class="user-info" id="userInfo">
                æ­£åœ¨è¯†åˆ«ç”¨æˆ·èº«ä»½...
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <select id="yearSelect">
                    <option value="">é€‰æ‹©å¹´ä»½</option>
                </select>
                
                <select id="monthSelect">
                    <option value="">é€‰æ‹©æœˆä»½</option>
                    <option value="01">1æœˆ</option>
                    <option value="02">2æœˆ</option>
                    <option value="03">3æœˆ</option>
                    <option value="04">4æœˆ</option>
                    <option value="05">5æœˆ</option>
                    <option value="06">6æœˆ</option>
                    <option value="07">7æœˆ</option>
                    <option value="08">8æœˆ</option>
                    <option value="09">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
                
                <button onclick="loadScheduleData()">åˆ·æ–°æ•°æ®</button>
                <button onclick="showAllData()">æ˜¾ç¤ºå…¨éƒ¨ç­è¡¨</button>
                <button onclick="toggleDebug()">è°ƒè¯•ä¿¡æ¯</button>
            </div>
        </div>
        
        <div class="calendar-container" id="calendarContainer">
            <div class="loading">
                â³ æ­£åœ¨åŠ è½½ç­è¡¨æ•°æ®...
            </div>
        </div>
        
        <div class="debug-info" id="debugInfo" style="display: none;">
            <!-- è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            EXCEL_URL: 'schedule.xlsx',
            DEFAULT_USER_ID: 'current_user'
        };

        let allScheduleData = [];
        let currentUserId = CONFIG.DEFAULT_USER_ID;
        let currentUserShifts = [];

        // è°ƒè¯•å‡½æ•°
        function logDebug(message) {
            console.log(message);
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv.style.display !== 'none') {
                debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            }
        }

        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        // æ£€æµ‹ç”¨æˆ·ID
        function detectUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('userid');
            
            if (!userId) {
                userId = localStorage.getItem('currentUserId');
            }
            
            if (!userId) {
                const demoUsers = ['USER001', 'USER002', 'USER003', 'USER004'];
                userId = demoUsers[Math.floor(Math.random() * demoUsers.length)];
                localStorage.setItem('currentUserId', userId);
            }
            
            logDebug(`æ£€æµ‹åˆ°ç”¨æˆ·ID: ${userId}`);
            return userId;
        }

        // åŠ è½½Excelæ•°æ®
        async function loadScheduleData() {
            try {
                showLoading('æ­£åœ¨åŠ è½½Excelæ•°æ®...');
                logDebug(`å¼€å§‹åŠ è½½Excelæ–‡ä»¶: ${CONFIG.EXCEL_URL}`);
                
                const response = await fetch(CONFIG.EXCEL_URL);
                logDebug(`HTTPå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                logDebug(`æˆåŠŸè·å–æ–‡ä»¶ï¼Œå¤§å°: ${arrayBuffer.byteLength} å­—èŠ‚`);
                
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æœªæ­£ç¡®ä¸Šä¼ ');
                }
                
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                logDebug(`Excelå·¥ä½œç°¿åŒ…å«å·¥ä½œè¡¨: ${workbook.SheetNames.join(', ')}`);
                
                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                logDebug(`æˆåŠŸè§£ææ•°æ®ï¼Œå…± ${jsonData.length} è¡Œ`);
                
                if (jsonData.length === 0) {
                    throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                }
                
                // æ˜¾ç¤ºExcelåˆ—åï¼ˆç”¨äºè°ƒè¯•ï¼‰
                if (jsonData.length > 0) {
                    const columns = Object.keys(jsonData[0]);
                    logDebug(`Excelåˆ—å: ${columns.join(', ')}`);
                }
                
                // å¤„ç†æ•°æ®
                allScheduleData = jsonData.map((row, index) => {
                    // å°è¯•å¤šç§å¯èƒ½çš„åˆ—å
                    const userId = row['user ID'] || row['userID'] || row['userId'] || row['ç”¨æˆ·ID'] || `USER${(index % 4) + 1}`;
                    const shiftCode = row['ç­æ¬¡ä»£ç '] || row['ç­æ¬¡'] || row['shift'] || 'A';
                    const shiftDate = formatDate(row['ç­æ¬¡æ—¥æœŸ'] || row['æ—¥æœŸ'] || row['date']);
                    const startTime = formatTime(row['ç­æ¬¡å¼€å§‹æ—¶é—´'] || row['å¼€å§‹æ—¶é—´'] || row['startTime'] || '09:00');
                    const endTime = formatTime(row['ç­æ¬¡ç»“æŸæ—¶é—´'] || row['ç»“æŸæ—¶é—´'] || row['endTime'] || '18:00');
                    
                    return {
                        userId: userId,
                        shiftCode: shiftCode,
                        shiftDate: shiftDate,
                        startTime: startTime,
                        endTime: endTime
                    };
                });
                
                logDebug(`å¤„ç†åçš„ç­è¡¨æ•°æ®: ${allScheduleData.length} æ¡è®°å½•`);
                
                // æ£€æµ‹å½“å‰ç”¨æˆ·
                currentUserId = detectUserId();
                document.getElementById('userInfo').textContent = `å½“å‰ç”¨æˆ·: ${currentUserId}`;
                
                // ç­›é€‰å½“å‰ç”¨æˆ·çš„ç­è¡¨
                filterUserShifts();
                populateYearFilter();
                renderCalendar();
                
                showLoading('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼');
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                const errorMsg = `æ— æ³•åŠ è½½Excelæ–‡ä»¶: ${error.message}<br>
                                  è¯·æ£€æŸ¥: <br>
                                  1. Excelæ–‡ä»¶æ˜¯å¦å·²æ­£ç¡®ä¸Šä¼ åˆ°GitHub<br>
                                  2. æ–‡ä»¶åæ˜¯å¦ä¸º "schedule.xlsx"<br>
                                  3. æ–‡ä»¶æ˜¯å¦åŒ…å«æ•°æ®`;
                showError(errorMsg);
                logDebug(`é”™è¯¯è¯¦æƒ…: ${error.stack}`);
            }
        }

        // å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆformatDate, formatTime, filterUserShifts, populateYearFilter, renderCalendarç­‰ï¼‰
        function formatDate(dateValue) {
            if (!dateValue) return '';
            if (dateValue instanceof Date) return dateValue.toISOString().split('T')[0];
            
            const dateStr = String(dateValue);
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
            }
            return dateStr.split(' ')[0];
        }

        function formatTime(timeValue) {
            if (!timeValue) return '09:00';
            if (timeValue instanceof Date) return timeValue.toTimeString().substring(0, 5);
            
            const timeStr = String(timeValue);
            if (timeStr.includes(':')) return timeStr.substring(0, 5);
            return timeStr;
        }

        function filterUserShifts() {
            currentUserShifts = allScheduleData.filter(shift => shift.userId === currentUserId);
            logDebug(`ç”¨æˆ· ${currentUserId} çš„ç­è¡¨æ•°é‡: ${currentUserShifts.length}`);
        }

        function populateYearFilter() {
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>';
            
            const years = new Set();
            allScheduleData.forEach(shift => {
                if (shift.shiftDate) {
                    const year = shift.shiftDate.split('-')[0];
                    years.add(year);
                }
            });
            
            Array.from(years).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                yearSelect.appendChild(option);
            });
            
            logDebug(`å¯é€‰çš„å¹´ä»½: ${Array.from(years).join(', ')}`);
        }

        function renderCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            const selectedYear = document.getElementById('yearSelect').value;
            const selectedMonth = document.getElementById('monthSelect').value;
            
            logDebug(`ç­›é€‰æ¡ä»¶ - å¹´ä»½: ${selectedYear || 'å…¨éƒ¨'}, æœˆä»½: ${selectedMonth || 'å…¨éƒ¨'}`);
            
            let filteredShifts = currentUserShifts;
            
            if (selectedYear) {
                filteredShifts = filteredShifts.filter(shift => 
                    shift.shiftDate && shift.shiftDate.startsWith(selectedYear)
                );
            }
            
            if (selectedMonth) {
                filteredShifts = filteredShifts.filter(shift => 
                    shift.shiftDate && shift.shiftDate.substring(5, 7) === selectedMonth
                );
            }
            
            logDebug(`ç­›é€‰åçš„ç­è¡¨æ•°é‡: ${filteredShifts.length}`);
            
            if (filteredShifts.length === 0) {
                calendarContainer.innerHTML = `
                    <div class="loading">
                        ğŸ“ å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— ç­è¡¨æ•°æ®<br>
                        <small>ç”¨æˆ·: ${currentUserId}, æ•°æ®æ€»æ•°: ${allScheduleData.length}</small>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆæ—¥å†çš„ä»£ç ä¿æŒä¸å˜...
            const shiftsByMonth = {};
            filteredShifts.forEach(shift => {
                if (!shift.shiftDate) return;
                const monthKey = shift.shiftDate.substring(0, 7);
                if (!shiftsByMonth[monthKey]) shiftsByMonth[monthKey] = [];
                shiftsByMonth[monthKey].push(shift);
            });
            
            let calendarHTML = '';
            Object.keys(shiftsByMonth).sort().forEach(monthKey => {
                const shifts = shiftsByMonth[monthKey];
                const [year, month] = monthKey.split('-');
                calendarHTML += generateMonthCalendar(year, parseInt(month), shifts);
            });
            
            calendarContainer.innerHTML = calendarHTML;
        }

        function generateMonthCalendar(year, month, shifts) {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                               'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            
            let calendarHTML = `
                <div class="month-section">
                    <div class="month-header">
                        ${year}å¹´ ${monthNames[month - 1]}
                    </div>
                    <div class="weekdays">
                        <div class="weekday">å‘¨æ—¥</div><div class="weekday">å‘¨ä¸€</div>
                        <div class="weekday">å‘¨äºŒ</div><div class="weekday">å‘¨ä¸‰</div>
                        <div class="weekday">å‘¨å››</div><div class="weekday">å‘¨äº”</div>
                        <div class="weekday">å‘¨å…­</div>
                    </div>
                    <div class="days-grid">
            `;
            
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += `<div class="day other-month"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayShifts = shifts.filter(shift => shift.shiftDate === dateStr);
                
                calendarHTML += `<div class="day">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                dayShifts.forEach(shift => {
                    calendarHTML += `
                        <div class="shift-item shift-${shift.shiftCode}" 
                             onclick="showShiftDetails('${shift.shiftCode}', '${shift.startTime}', '${shift.endTime}')">
                            ${shift.shiftCode}ç­ ${shift.startTime}-${shift.endTime}
                        </div>
                    `;
                });
                
                calendarHTML += `</div>`;
            }
            
            const totalCells = 42;
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += `<div class="day other-month"></div>`;
            }
            
            calendarHTML += `</div></div>`;
            return calendarHTML;
        }

        function showShiftDetails(shiftCode, startTime, endTime) {
            alert(`ç­æ¬¡è¯¦æƒ…:\n\nç­æ¬¡: ${shiftCode}ç­\næ—¶é—´: ${startTime} - ${endTime}`);
        }

        function showAllData() {
            currentUserShifts = allScheduleData;
            document.getElementById('userInfo').textContent = 'ç®¡ç†å‘˜è§†å›¾ - æ˜¾ç¤ºæ‰€æœ‰å‘˜å·¥ç­è¡¨';
            renderCalendar();
        }

        function showLoading(message) {
            document.getElementById('calendarContainer').innerHTML = `
                <div class="loading">${message}</div>
            `;
        }

        function showError(message) {
            document.getElementById('calendarContainer').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('yearSelect').addEventListener('change', renderCalendar);
            document.getElementById('monthSelect').addEventListener('change', renderCalendar);
            loadScheduleData();
        });
    </script>
</body>
</html>
