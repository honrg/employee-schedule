<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å‘˜å·¥ç­è¡¨ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        select, button {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:focus, button:hover {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        button {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .calendar-container {
            padding: 20px;
        }
        
        .month-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .month-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #34495e;
            color: white;
        }
        
        .weekday {
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-right: 1px solid #2c3e50;
        }
        
        .weekday:last-child {
            border-right: none;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
        }
        
        .day {
            background: white;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #e9ecef;
            position: relative;
        }
        
        .day.other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .shift-item {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .shift-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .shift-A { background: #2ecc71; }
        .shift-B { background: #f39c12; }
        .shift-C { background: #9b59b6; }
        .shift-D { background: #e74c3c; }
        .shift-E { background: #1abc9c; }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .user-info {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .day {
                min-height: 80px;
                padding: 5px;
                font-size: 12px;
            }
            
            .shift-item {
                font-size: 10px;
                padding: 2px 4px;
            }
            
            .filter-group {
                flex-direction: column;
            }
            
            select, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… æ™ºèƒ½å‘˜å·¥ç­è¡¨ç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·èº«ä»½ Â· å®æ—¶æ›´æ–°ç­è¡¨æ•°æ®</p>
            <div class="user-info" id="userInfo">
                æ­£åœ¨è¯†åˆ«ç”¨æˆ·èº«ä»½...
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <select id="yearSelect">
                    <option value="">é€‰æ‹©å¹´ä»½</option>
                </select>
                
                <select id="monthSelect">
                    <option value="">é€‰æ‹©æœˆä»½</option>
                    <option value="01">1æœˆ</option>
                    <option value="02">2æœˆ</option>
                    <option value="03">3æœˆ</option>
                    <option value="04">4æœˆ</option>
                    <option value="05">5æœˆ</option>
                    <option value="06">6æœˆ</option>
                    <option value="07">7æœˆ</option>
                    <option value="08">8æœˆ</option>
                    <option value="09">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
                
                <button onclick="loadScheduleData()">åˆ·æ–°æ•°æ®</button>
                <button onclick="showAllData()">æ˜¾ç¤ºå…¨éƒ¨ç­è¡¨</button>
            </div>
        </div>
        
        <div class="calendar-container" id="calendarContainer">
            <div class="loading">
                â³ æ­£åœ¨åŠ è½½ç­è¡¨æ•°æ®...
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            EXCEL_URL: 'schedule.xlsx', // Excelæ–‡ä»¶è·¯å¾„ï¼Œä¸HTMLæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
            DEFAULT_USER_ID: 'current_user' // é»˜è®¤ç”¨æˆ·IDï¼Œä¼šè‡ªåŠ¨æ£€æµ‹
        };

        // å…¨å±€å˜é‡
        let allScheduleData = [];
        let currentUserId = CONFIG.DEFAULT_USER_ID;
        let currentUserShifts = [];

        // æ¨¡æ‹Ÿç”¨æˆ·IDæ£€æµ‹ - åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»é£ä¹¦æˆ–å…¶ä»–ç³»ç»Ÿè·å–
        function detectUserId() {
            // æ–¹æ³•1: ä»URLå‚æ•°è·å–
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('userid');
            
            // æ–¹æ³•2: ä»æœ¬åœ°å­˜å‚¨è·å–ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            if (!userId) {
                userId = localStorage.getItem('currentUserId');
            }
            
            // æ–¹æ³•3: æ¨¡æ‹Ÿéšæœºç”¨æˆ·ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            if (!userId) {
                const demoUsers = ['USER001', 'USER002', 'USER003', 'USER004'];
                userId = demoUsers[Math.floor(Math.random() * demoUsers.length)];
                localStorage.setItem('currentUserId', userId);
            }
            
            return userId;
        }

        // åŠ è½½Excelæ•°æ®
        async function loadScheduleData() {
            try {
                showLoading('æ­£åœ¨åŠ è½½Excelæ•°æ®...');
                
                const response = await fetch(CONFIG.EXCEL_URL);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                allScheduleData = jsonData.map(row => ({
                    userId: row['user ID'] || row['userID'] || row['userId'],
                    shiftCode: row['ç­æ¬¡ä»£ç '],
                    shiftDate: formatDate(row['ç­æ¬¡æ—¥æœŸ']),
                    startTime: formatTime(row['ç­æ¬¡å¼€å§‹æ—¶é—´']),
                    endTime: formatTime(row['ç­æ¬¡ç»“æŸæ—¶é—´'])
                }));
                
                // æ£€æµ‹å½“å‰ç”¨æˆ·
                currentUserId = detectUserId();
                document.getElementById('userInfo').textContent = `å½“å‰ç”¨æˆ·: ${currentUserId}`;
                
                // ç­›é€‰å½“å‰ç”¨æˆ·çš„ç­è¡¨
                filterUserShifts();
                populateYearFilter();
                renderCalendar();
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½Excelæ–‡ä»¶ï¼Œè¯·ç¡®ä¿ schedule.xlsx æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            if (dateValue instanceof Date) {
                return dateValue.toISOString().split('T')[0];
            }
            
            const dateStr = String(dateValue);
            // å¤„ç†å„ç§å¯èƒ½çš„æ—¥æœŸæ ¼å¼
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
            } else if (dateStr.includes('-')) {
                return dateStr.split(' ')[0]; // å»é™¤æ—¶é—´éƒ¨åˆ†
            }
            
            return dateStr;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeValue) {
            if (!timeValue) return '';
            
            if (timeValue instanceof Date) {
                return timeValue.toTimeString().substring(0, 5);
            }
            
            const timeStr = String(timeValue);
            // å¤„ç†æ—¶é—´æ ¼å¼
            if (timeStr.includes(':')) {
                return timeStr.substring(0, 5); // åªå–HH:mméƒ¨åˆ†
            }
            
            return timeStr;
        }

        // ç­›é€‰å½“å‰ç”¨æˆ·çš„ç­è¡¨
        function filterUserShifts() {
            currentUserShifts = allScheduleData.filter(shift => 
                shift.userId === currentUserId
            );
        }

        // å¡«å……å¹´ä»½ç­›é€‰å™¨
        function populateYearFilter() {
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>';
            
            const years = new Set();
            allScheduleData.forEach(shift => {
                if (shift.shiftDate) {
                    const year = shift.shiftDate.split('-')[0];
                    years.add(year);
                }
            });
            
            Array.from(years).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                yearSelect.appendChild(option);
            });
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            const selectedYear = document.getElementById('yearSelect').value;
            const selectedMonth = document.getElementById('monthSelect').value;
            
            // ç­›é€‰æ•°æ®
            let filteredShifts = currentUserShifts;
            
            if (selectedYear) {
                filteredShifts = filteredShifts.filter(shift => 
                    shift.shiftDate && shift.shiftDate.startsWith(selectedYear)
                );
            }
            
            if (selectedMonth) {
                filteredShifts = filteredShifts.filter(shift => 
                    shift.shiftDate && shift.shiftDate.substring(5, 7) === selectedMonth
                );
            }
            
            if (filteredShifts.length === 0) {
                calendarContainer.innerHTML = `
                    <div class="loading">
                        ğŸ“ å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— ç­è¡¨æ•°æ®
                    </div>
                `;
                return;
            }
            
            // æŒ‰æœˆä»½åˆ†ç»„
            const shiftsByMonth = {};
            filteredShifts.forEach(shift => {
                if (!shift.shiftDate) return;
                
                const monthKey = shift.shiftDate.substring(0, 7); // YYYY-MM
                if (!shiftsByMonth[monthKey]) {
                    shiftsByMonth[monthKey] = [];
                }
                shiftsByMonth[monthKey].push(shift);
            });
            
            // ç”Ÿæˆæ—¥å†HTML
            let calendarHTML = '';
            
            Object.keys(shiftsByMonth).sort().forEach(monthKey => {
                const shifts = shiftsByMonth[monthKey];
                const [year, month] = monthKey.split('-');
                
                calendarHTML += generateMonthCalendar(year, parseInt(month), shifts);
            });
            
            calendarContainer.innerHTML = calendarHTML;
        }

        // ç”Ÿæˆå•æœˆæ—¥å†
        function generateMonthCalendar(year, month, shifts) {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                               'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            
            let calendarHTML = `
                <div class="month-section">
                    <div class="month-header">
                        ${year}å¹´ ${monthNames[month - 1]}
                    </div>
                    <div class="weekdays">
                        <div class="weekday">å‘¨æ—¥</div>
                        <div class="weekday">å‘¨ä¸€</div>
                        <div class="weekday">å‘¨äºŒ</div>
                        <div class="weekday">å‘¨ä¸‰</div>
                        <div class="weekday">å‘¨å››</div>
                        <div class="weekday">å‘¨äº”</div>
                        <div class="weekday">å‘¨å…­</div>
                    </div>
                    <div class="days-grid">
            `;
            
            // å¡«å……ç©ºç™½æ—¥æœŸï¼ˆä¸Šä¸ªæœˆçš„ï¼‰
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += `<div class="day other-month"></div>`;
            }
            
            // å¡«å……å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayShifts = shifts.filter(shift => shift.shiftDate === dateStr);
                
                calendarHTML += `<div class="day">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                dayShifts.forEach(shift => {
                    calendarHTML += `
                        <div class="shift-item shift-${shift.shiftCode}" 
                             onclick="showShiftDetails('${shift.shiftCode}', '${shift.startTime}', '${shift.endTime}')">
                            ${shift.shiftCode}ç­ ${shift.startTime}-${shift.endTime}
                        </div>
                    `;
                });
                
                calendarHTML += `</div>`;
            }
            
            // å¡«å……ç©ºç™½æ—¥æœŸï¼ˆä¸‹ä¸ªæœˆçš„ï¼‰
            const totalCells = 42; // 6è¡ŒÃ—7åˆ—
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += `<div class="day other-month"></div>`;
            }
            
            calendarHTML += `
                    </div>
                </div>
            `;
            
            return calendarHTML;
        }

        // æ˜¾ç¤ºç­æ¬¡è¯¦æƒ…
        function showShiftDetails(shiftCode, startTime, endTime) {
            alert(`ç­æ¬¡è¯¦æƒ…:\n\nç­æ¬¡: ${shiftCode}ç­\næ—¶é—´: ${startTime} - ${endTime}`);
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼ˆç®¡ç†å‘˜è§†å›¾ï¼‰
        function showAllData() {
            currentUserShifts = allScheduleData;
            document.getElementById('userInfo').textContent = 'ç®¡ç†å‘˜è§†å›¾ - æ˜¾ç¤ºæ‰€æœ‰å‘˜å·¥ç­è¡¨';
            renderCalendar();
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message) {
            document.getElementById('calendarContainer').innerHTML = `
                <div class="loading">
                    â³ ${message}
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('calendarContainer').innerHTML = `
                <div class="error">
                    âŒ ${message}
                </div>
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
            document.getElementById('yearSelect').addEventListener('change', renderCalendar);
            document.getElementById('monthSelect').addEventListener('change', renderCalendar);
            
            // åŠ è½½æ•°æ®
            loadScheduleData();
        });
    </script>
</body>
</html>